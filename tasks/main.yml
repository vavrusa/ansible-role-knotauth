---
- name: install from source
  include_tasks: from_source.yml
  when: knot_from_source

- name: install from packages
  include_tasks: from_pkgs.yml
  when: not knot_from_source

# Post-install
- name: set config path (FreeBSD)
  lineinfile:
    dest: /etc/rc.conf
    regexp: '^knot_config='
    line: "knot_config={{ knot_install_dir }}/etc/knot/knot.conf"
  when: ansible_os_family == "FreeBSD"

- name: Create all the required storage directories for zone files
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - "{{ knot_zones[-1]['storage'] }}"
  when: knot_zones[-1]['storage'] is defined

# Configuration
- name: Template Knot configuration
  template:
    src: knot.conf.j2
    dest: "{{ knot_install_dir }}/etc/knot/knot.conf"
    mode: 0640
    owner: "{{ knot_user }}"
    group: "{{ knot_group }}"
    validate: "knotc -c %s conf-check"
  notify: restart knot
  tags: dns

- name: Make sure the knot daemon is enabled and started
  service:
    name: "{{ knot_daemon }}"
    enabled: True
    state: started
