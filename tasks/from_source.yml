---
# Fetch dependencies (platform-specific)
- name: install dependencies (Debian/Ubuntu)
  apt:
    name: "{{ debian_source_deps }}"
    update_cache: yes
    cache_valid_time: 86400
    state: present
  when: ansible_os_family == "Debian"

- name: install dependencies (FreeBSD)
  pkgng:
    name: "{{ freebsd_source_deps }}"
    state: present
  when: ansible_os_family == "FreeBSD"

# Clone and build from sources
- name: git clone knot sources
  git:
    repo: https://gitlab.labs.nic.cz/labs/knot.git
    dest: /usr/local/src/knot
    version: "{{ knot_git_branch }}"
    update: yes

- name: configure
  shell: autoreconf -if && ./configure --prefix={{ knot_install_dir }} chdir=/usr/local/src/knot creates=/usr/local/src/knot/Makefile

- name: build
  command: make -j{{ansible_processor_count}} chdir=/usr/local/src/knot creates=/usr/local/src/knot/src/knotd

- name: install
  command: make install chdir=/usr/local/src/knot creates={{ knot_install_dir }}/sbin/knotd

# Post-installation
- name: add knot group
  group:
    name: "{{ knot_group }}"
    comment: "Knot DNS"

- name: add knot user
  user:
    name: "{{ knot_user }}"
    comment: "Knot DNS"
    home: "{{ knot_install_dir }}"
    shell: /bin/false
    groups: "{{ knot_group }}"
    system: yes

- name: make sure directories are writeable
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ knot_user }}"
    group: "{{ knot_group }}"
  with_items:
    - "{{ knot_install_dir }}/etc/knot"
    - "{{ knot_install_dir }}/var/lib/knot"
    - "{{ knot_install_dir }}/var/run/lib/knot"
